var bds={};bds.data_url="/stage_data";bds.left_url="left";bds.path_width=15;bds.path_color="blue";bds.dash_array="1, 30";bds.info_bar={info:{text:"info",link:"#"},how_to_play:{text:"how to play",link:"#"},dashboard:{text:"dashboard",link:"#"},save:{text:"save",link:"#"},start_over:{text:"start over",link:"#"},admin:{text:"admin",link:"/admin"}};bds.db=function(){var b={},c=localStorage;b.save=function(a,d){c[a]=JSON.stringify(d)};b.get=function(a){if(void 0!==c[a])return JSON.parse(c[a])};b.wipe=function(){c.clear();return b};return b}();bds.noop=function(){};bds.circles=function(){var b={},c=function(a){if(a){for(i=0;i<a;i++){var e=i==a-1,c=b.current.next()[0];b.current=b[c];e||setTimeout(b.current.hop,250*i)}setTimeout(b.current.pop,250*a)}else b.start.pop()},a=function(d,c,f){if(void 0===d)return[];c=c||b.current;f=f||[];if(!d)return f.push(c),!1;c=c.next();$.each(c,function(){a(d-1,b[this],f)});return f};b.add=function(a,c){b[a]=c;c.is_start()&&(b.start=c,b.current=b.start)};b.get=function(a){return b[a]};b.first=function(){c()};b.is_current=function(a){return b.current.id==
a};b.leave_and_land=function(a){b.current.drop();c(a)};b.complete_stage=function(a){b.current.complete(a);bds.keeper.add(10);a=b.current.id;var c=bds.db.get("completed"),f=bds.db.get(a);-1<$.inArray(f,c)||c.push(a);bds.db.save("completed",c)};b.get_potentials=a;return b}();
bds.make_circle=function(b,c){var a={},d=$(b),e=d3.select(b),f=e.attr("r");c=d3.select(c);var h=function(b,d){b=b||bds.noop;e.transition().duration(1E3).attr("r",4*f).each("end",function(){b();d||c.attr("font-size",20).style("fill","black")});return a},g=function(){e.transition().duration(500).attr("r",f);c.transition().attr("font-size",10).attr("dx",function(a){return a.x-10}).attr("dy",function(a){return a.y+5}).text("MC");return a};a.name=name;a.pop=h;a.drop=g;a.hop=function(){h(g,!0)};a.sticky=
!1;a.is_start=function(){return d.data("start")};a.next=function(){return d.data("next")};a.play=function(){bds.page.$board.fadeOut(1200,function(){bds.page.$stage.load("/stages/"+a.id,function(){$(this).fadeIn(1200)})})};a.potentialize=function(){h();d.on("click",function(){$.publish("bds_depotentialize",[a.id]);bds.circles.current=a;$.publish("bds_play",[null,3E3])})};a.complete=function(a,b){a=a||bds.noop;e.transition().duration(2500).style("fill","silver").style("stroke","black").each("end",function(){a();
c.style("fill","black");b?c.text("MC").attr("dx",function(a){return a.x-10}).attr("dy",function(a){return a.y+5}):c.text("Marketing Call")})};a.id=d.attr("id");$.subscribe("bds_depotentialize",function(b,c){a.id!=c&&(g(),d.off())});bds.circles.add(a.id,a);return a};bds.make_actions=function(b){var c=$('<div id="actions">'),a=$("<table><tbody></tbody></table>"),d=$("<tr>");a.find("tbody").append(d);c.append(a);$.each("start roller dice go score start_over".split(" "),function(){var a=$("<td>"),b=$("<div id="+this+">");bds[this]=bds["make_"+this](b);a.append(b);d.append(a)});c.prependTo(b);return{}};bds.make_page=function(b,c){var a={},d=b.find(c),e=$('<div id="stage">');e.hide();a.$board=d;a.$stage=e;b.append(e);return a};
bds.make_dice=function(b){var c={},a=$('<a href="#"></a>'),d=function(){var b;b='<img src="/assets/dice/Blue_'+c.current_face;a.html("").append(b+'.png" />')};c.roll=function(){c.current_face=Math.floor(3*Math.random()+1);d();$.publish("bds_rolled")};c.on=d;c.off=function(){var b;b='<img src="/assets/dice/Blue_'+c.current_face;b+='_frozen.png" />';a.html("").append(b)};b.html(a);return c};
bds.make_roller=function(b){var c={},a=$('<a href="#"></a>'),d=$("<div>"),e=$("<div>");d.css("width","75px").css("height","75px").css("background-image",'url("/assets/controls/roller1.jpg")').css("background-repeat","no-repeat").css("display","none");e.css("width","75px").css("height","75px").css("background-image",'url("/assets/controls/roller1_gray.jpg")').css("background-repeat","no-repeat");e.append(d);a.append(e);a.on("click",function(){$.publish("bds_rolling")});e=function(){d.fadeOut("slow")};
c.on=function(){d.fadeIn("slow")};c.off=e;e();b.html(a);return c};bds.make_start=function(b){var c={},a=$('<a href="#"></a>'),d=function(){a.html("").append('<img src="/assets/controls/start.jpg" />')};a.on("click",function(){$.publish("bds_start")});c.on=d;c.off=function(){a.html("").append('<img src="/assets/controls/start_gray.jpg" />')};d();b.html(a);return c};
bds.make_go=function(b){var c={},a=$('<a href="#"></a>'),d=function(){a.html('<img src="/assets/controls/go_gray.png" />')};a.on("click",function(){$.publish("bds_go")});c.on=function(){a.html('<img src="/assets/controls/go.png" />')};c.off=d;d();b.html(a);return c};
bds.make_score=function(b){var c={},a=$("<div>"),d=$("<div>Score</div>"),e=$("<div>"),f=function(){var a=bds.db.get("score")||0;e.text(a)};c.on=f;c.update=function(){f()};f();a.append(d).append("<br />").append(e);a.css("height","100%");d.css("font-size","14px").css("padding","4px");e.css("font-size","36px").css("margin","auto").css("text-align","center");b.html(a);return c};
bds.make_start_over=function(b){var c={},a=$("<div>"),d=function(){a.html('<img src="/assets/controls/start-over.jpg" />')};a.on("click",function(){alert("not working yet")});d();b.html(a);c.on=d;c.off=function(){};return c};
bds.make_banner=function(b){var c=$('<div id="top_banner">'),a=$("<div>"),d=$("<div>");for(link in bds.info_bar){var e=$('<a href="'+bds.info_bar[link].link+'"></a>');e.text(bds.info_bar[link].text);a.append(e);a.append(" | ")}d.css("width","600px").css("position","absolute").css("left","50%").css("margin-left","-300px").css("margin-top","50px").css("padding","12px").css("height","300px").css("color","white").css("background-color","rgba(20,10,75,0.9)").css("border-left","2px dotted white").css("border-right",
"2px dotted white").css("border-bottom","2px dotted white").css("display","none");d.append("<h1>Dashboard</h1>");d.append("<p>get from server? ... </p>");a.css("padding","6px").css("float","right");c.append(a);d.prependTo(b);c.prependTo(b);a.on("click",function(){d.fadeIn("slow")});d.on("click",function(){$(this).fadeOut();return!1});return{}};bds.keeper=function(){var b={};SCORE="score";b.add=function(b){var a=bds.db.get(SCORE)||0;bds.db.save(SCORE,a+b);$.publish("bds_score_change")};return b}();(function(){var b=$({});$.subscribe=function(){b.on.apply(b,arguments)};$.unsubscribe=function(){b.off.apply(b,arguments)};$.publish=function(){b.trigger.apply(b,arguments)}})(jQuery);bds.make_app=function(b,c,a){var d={},e=!1;bds.controls=bds.make_actions($(a.content));bds.page=bds.make_page($(a.content),a.svg_container);bds.banner=bds.make_banner($(a.content));bds.make_board(b,c,a);$.subscribe("bds_start",function(){d.started||(e=d.started=!0,bds.circles.first(),bds.start.off(),$.publish("bds_play",[null,3E3]))});$.subscribe("bds_go",function(){if(d.started&&d.moveable){d.moveable=!1;e=!0;var a=bds.circles.get_potentials(bds.dice.current_face);1===a.length?(bds.circles.leave_and_land(bds.dice.current_face),
$.publish("bds_play",[null,3E3])):$.each(a,function(){this.potentialize()});bds.go.off();bds.dice.off()}});$.subscribe("bds_stage_complete",function(){d.rollable=!0;e=!1;bds.circles.complete_stage(function(){bds.roller.on()})});$.subscribe("bds_rolled",function(){d.rollable=!1;bds.roller.off();bds.go.on()});$.subscribe("bds_rolling",function(){d.rollable&&(bds.dice.roll(),d.rollable=!1,d.moveable=!0)});$.subscribe("bds_play",function(a,b,c){if(e&&(!b||bds.circles.is_current(b)))setTimeout(function(){bds.circles.current.play()},
c||0)});$.subscribe("bds_score_change",function(){bds.score.update()});$.subscribe("bds_show_potentials",function(){alert("test");var a=bds.circles.get_potentials(bds.dice.current_face);alert(a.length)});bds.db.wipe().save("completed",[]);d.started=!1;d.moveable=!1;d.rollable=!1;return d};(function(b){b.fn.bds=function(c){c=b.extend({},b.fn.bds.defaultOptions,c);this.each(function(){var a=b(this),c=b('<div id="left"></div>'),e=b('<div id="svg_container"></div>');a.append(c);a.append(e);var f=d3.select("#"+e.attr("id")).append("svg").attr("width",900).attr("height",900);d3.json(bds.data_url,function(b,g){"undefined"===typeof Storage&&alert("This application requires HTML5 support. Please use a different browser.");bds.make_app(f,g,{content:"#"+a.attr("id"),svg_container:"#"+e.attr("id")});
c.load(bds.left_url)})});return this};b.fn.bds.defaultOptions={a:"1",b:"2"}})(jQuery);